<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Apple Pencil Handwriting Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            touch-action: none; /* Prevent scrolling while drawing */
        }
        
        .toolbar {
            background: white;
            padding: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        button {
            padding: 8px 16px;
            background: #007AFF;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
        }
        
        button:active {
            background: #005BBB;
        }
        
        .color-picker {
            width: 40px;
            height: 40px;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
        }
        
        .size-slider {
            width: 150px;
        }
        
        #canvas {
            display: block;
            background: white;
            touch-action: none;
            cursor: crosshair;
        }
        
        .info {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            border-radius: 8px;
            font-size: 12px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="toolbar">
        <button id="clearBtn">Clear</button>
        <button id="undoBtn">Undo</button>
        <input type="color" id="colorPicker" class="color-picker" value="#000000">
        <label>Size: <input type="range" id="sizeSlider" class="size-slider" min="1" max="20" value="2"></label>
        <label>Pressure Sensitive: <input type="checkbox" id="pressureToggle" checked></label>
    </div>
    
    <canvas id="canvas"></canvas>
    
    <div class="info" id="info">
        Ready to draw...
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const info = document.getElementById('info');
        
        // Set canvas size
        function resizeCanvas() {
            const toolbar = document.querySelector('.toolbar');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight - toolbar.offsetHeight;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
        
        // Drawing state
        let isDrawing = false;
        let currentPath = [];
        let paths = [];
        let currentColor = '#000000';
        let baseSize = 2;
        let usePressure = true;
        
        // UI controls
        document.getElementById('clearBtn').addEventListener('click', () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            paths = [];
            currentPath = [];
        });
        
        document.getElementById('undoBtn').addEventListener('click', () => {
            if (paths.length > 0) {
                paths.pop();
                redrawAll();
            }
        });
        
        document.getElementById('colorPicker').addEventListener('change', (e) => {
            currentColor = e.target.value;
        });
        
        document.getElementById('sizeSlider').addEventListener('input', (e) => {
            baseSize = parseInt(e.target.value);
        });
        
        document.getElementById('pressureToggle').addEventListener('change', (e) => {
            usePressure = e.target.checked;
        });
        
        // Pointer events for Apple Pencil support
        canvas.addEventListener('pointerdown', startDrawing);
        canvas.addEventListener('pointermove', draw);
        canvas.addEventListener('pointerup', stopDrawing);
        canvas.addEventListener('pointercancel', stopDrawing);
        
        function startDrawing(e) {
            // Only respond to primary pointer (first touch/pen)
            if (!e.isPrimary) return;
            
            isDrawing = true;
            currentPath = [];
            
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            currentPath.push({
                x: x,
                y: y,
                pressure: e.pressure || 0.5,
                tiltX: e.tiltX || 0,
                tiltY: e.tiltY || 0,
                pointerType: e.pointerType,
                color: currentColor,
                baseSize: baseSize
            });
            
            updateInfo(e);
        }
        
        function draw(e) {
            if (!isDrawing) return;
            if (!e.isPrimary) return;
            
            e.preventDefault();
            
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            const point = {
                x: x,
                y: y,
                pressure: e.pressure || 0.5,
                tiltX: e.tiltX || 0,
                tiltY: e.tiltY || 0,
                pointerType: e.pointerType,
                color: currentColor,
                baseSize: baseSize
            };
            
            currentPath.push(point);
            
            // Draw the line segment
            if (currentPath.length > 1) {
                const prevPoint = currentPath[currentPath.length - 2];
                drawLine(prevPoint, point);
            }
            
            updateInfo(e);
        }
        
        function stopDrawing(e) {
            if (!isDrawing) return;
            
            isDrawing = false;
            if (currentPath.length > 0) {
                paths.push([...currentPath]);
            }
            currentPath = [];
            
            info.textContent = 'Drawing stopped';
        }
        
        function drawLine(from, to) {
            ctx.beginPath();
            ctx.moveTo(from.x, from.y);
            ctx.lineTo(to.x, to.y);
            
            // Apply pressure sensitivity
            let lineWidth = to.baseSize;
            if (usePressure && to.pointerType === 'pen') {
                lineWidth = to.baseSize * (0.5 + to.pressure * 1.5);
            }
            
            ctx.strokeStyle = to.color;
            ctx.lineWidth = lineWidth;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.stroke();
        }
        
        function redrawAll() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            for (let path of paths) {
                for (let i = 1; i < path.length; i++) {
                    drawLine(path[i - 1], path[i]);
                }
            }
        }
        
        function updateInfo(e) {
            let infoText = `Type: ${e.pointerType}\n`;
            if (e.pointerType === 'pen') {
                infoText += `Pressure: ${e.pressure.toFixed(2)}\n`;
                infoText += `Tilt X: ${e.tiltX}°\n`;
                infoText += `Tilt Y: ${e.tiltY}°`;
            }
            info.textContent = infoText;
        }
        
        // Prevent default touch behaviors
        document.addEventListener('touchstart', (e) => {
            if (e.target === canvas) {
                e.preventDefault();
            }
        }, { passive: false });
        
        document.addEventListener('touchmove', (e) => {
            if (e.target === canvas) {
                e.preventDefault();
            }
        }, { passive: false });
    </script>
</body>
</html>